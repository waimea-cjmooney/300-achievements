{#=====================================================
  Thing page
  - Shows details of a single thing
  - Has a delete link to remove it
=====================================================#}

{% extends 'pages/base.jinja' %}


{% block title %}

    {{ game.name }} - Platinum Tracker

{% endblock %}


{% block content %}

    <a role="button" href="/">Home</a>

    <article id="game-article">

        <header id="game-header">
            <span id="game-text">
                <h2>{{ game.name }}</h2>
                <h4>{{ game.publishers }}</h4>
                <p id="game-desc">{{ game.description }}</p>
            </span>

            <span id="game-right">
                {% if game.header_img %}
                    <img src="{{ game.header_img }}" alt="Header image" id="header-img">
                {% else %}
                    <img src="/static/images/missing.png" alt="No header image available" id="header-img">
                {% endif %}

                {# Achievement progress bar and percentage #}
                <span id="game-progress">
                    <strong>
                        {# 1/32 #}
                        {{ (achievements | rejectattr("date", "equalto", none) | list | length) }}/{{ achievements | length if achievements | length > 0 else 0 }}
                    </strong>

                    {# Progress bar #}
                    <progress value="{{ achievements | rejectattr('date', 'equalto', none) | list | count }}" max="{{ achievements | length }}"></progress>

                    <strong>
                        {# 23% #}
                        {{ ((achievements | rejectattr("date", "equalto", none) | list | count) / (achievements | length if achievements | length > 0 else 1) * 100) | round(0, 'common') | int if achievements | length > 0 else 0 }}%
                    </strong>
                </span>

                {# Only show delete link if logged in AND owner #}
                {% if session.user_username and (game.added_by == session.user_username) %}
                    <a role="button" href="/delete/game/{{ game.id }}" onclick="return confirm('Delete game? This action is permanent and can NOT be undone.');">Delete</a>
                {% endif %}
            </span>
        </header>

        <span id="achievements">
            {% for achievement in achievements %}
                <span id="ach{{ achievement.id }}"></span>
                <span id="achievement">
                    {% if achievement.date %}
                        <a href="/uncomplete/{{ game.id }}/{{achievement.id}}">üóπ</a>
                    {% else %}
                        <a href="/complete/{{ game.id }}/{{achievement.id}}">‚òê</a>
                    {% endif %}

                    <span id="achievement-content">
                        {% if achievement.icon_img %}
                            <img src="{{ achievement.icon_img }}" alt="Achievement icon" id="achievement-icon">
                        {% endif %}

                        <span id="ach-title">
                            <strong>{{ achievement.name }}</strong> 
                            
                            <span id="ach-desc">
                                {% if achievement.date %}<p>{{ achievement.date }}</p>{% endif %}
                                <p>{{ achievement.description }}</p>

                                {% if achievement.location %}
                                    <p>Location: {{ achievement.location }}</p>
                                {% endif %}
                                {% if achievement.requirements %}
                                    <p>Requirements: {{ achievement.requirements }}</p>
                                {% endif %}
                            </span>
                        </span>

                        {% if session.user_username and (game.added_by == session.user_username) %}
                            <a href="/delete/achievement/{{ game.id }}/{{ achievement.id }}" onclick="return confirm('Delete achievement? This can NOT be undone.');">üóë</a>
                        {% endif %}

                    </span>
                </span>
            {% else %}
                <p>No achievements registered for this game yet.</p>
            {% endfor %}

            <footer>

                {# Only show add button if logged in AND owner #}
                {% if session.user_username and (game.added_by == session.user_username) %}

                    <a role="button" href="/form/achievement/{{ game.id }}">Add</a>

                {% else %}

                    Created by: <strong>{{ game.added_by }}</strong>

                {% endif %}

            </footer>
        </span>
    </article>

    {% if scroll %}
        <script>
            const el = document.getElementById('ach{{ scroll }}');
            if (el) el.scrollIntoView({block: 'center'});
        </script>
    {% endif %}

{% endblock %}

